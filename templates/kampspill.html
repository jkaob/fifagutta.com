{% extends "base.html" %}

{% block content %}


<div class="w3-content w3-container w3-padding-64">
  
  {% if session.user_id %}

    <div id="loginMessage">
      <div class="w3-panel w3-center w3-xlarge w3-green w3-margin-top" >
        Velkommen, {{ session.username }}!
        <!-- <span id="usernameDisplay"></span>! -->
      </div>
      <div class="w3-center w3-medium w3-margin-top w3-text-black">
        <p>Her kan du tippe resultat på de neste kampene i kokos-ligaen! <br> 
          Husk å plassere spillene senest én time før kampstart.</p>
          
        <p> Man får <b>1 poeng</b> for å tippe riktig H-U-B, og <b>1 bonuspoeng</b> for riktig resultat.
          <br>Tipsene kan <b>ikke</b> endres etter de er plassert.</p> 
      </div>
    </div>

  <!-- Login box -->
  {% else %}
    <div id="login" class="w3-card w3-padding w3-margin-top w3-pale-green w3-center">    
      <label for="passwordInput">Skriv inn ditt <b>kodeord</b> for å kunne plassere spill:</label>
      <input type="password" id="passwordInput" class="w3-input w3-border w3-margin-top" style="max-width:300px; margin: auto;">
      <button class="w3-button w3-black w3-margin-top" 
              onclick="attemptLogin(document.getElementById('passwordInput').value)">Logg inn
      </button>
    </div>
  {% endif %}
</div>


<style>
  #bets.locked {
    pointer-events: none;      /* disables clicks inside */
    opacity: 0.4;              /* makes it visually greyed out */
  }
</style>

<div class="w3-content w3-container w3-padding-32 {% if not session.user_id %}locked{% endif %}" id="bets">
  <div class="w3-xlarge w3-center w3-blue w3-padding-10">Neste kamper</div>

  {% if next_matches %}
    {% for match in next_matches %}
      <div class="w3-card w3-padding w3-margin-bottom w3-light-grey w3-center">
        <div class="w3-large">
          Runde {{ match.round_number }}:&nbsp;&nbsp;&nbsp;&nbsp; <b> {{ match.home_team }}</b> vs <b>{{ match.away_team }}</b>
        </div>
        <div class="w3-small"> 
          {{ match.play_date.strftime('%d.%m.%Y') }} &nbsp;&nbsp; {{ match.play_date.strftime('%H:%M') }} 
        </div>

        <div style="margin-top:10px;">

          {% if match.id in user_bets %}
            {# show their existing bet #}
            <div>
              <span class="w3-tag w3-light-blue">
                {{ user_bets[match.id].goals_home }} - {{ user_bets[match.id].goals_away }}
                
              </span>
                {% set result_letter = 
                  'H' if user_bets[match.id].goals_home > user_bets[match.id].goals_away 
                  else 'B' if user_bets[match.id].goals_home < user_bets[match.id].goals_away 
                  else 'U' 
                %}        
              <span class="w3-tag w3-margin-left 
                          {% if result_letter == 'H' %} w3-blue
                          {% elif result_letter == 'B' %} w3-black
                          {% else %} w3-grey {% endif %}">
                {{ result_letter }}
              </span>
            </div>
          
          {% else %}

            <form method="POST" action="{{ url_for('bets.place_bet') }}" style="display:inline-block;"
              onsubmit="event.preventDefault(); placeBet(
                {{ match.id }}, 
                Number(document.getElementById('home_{{ loop.index }}').value),
                Number(document.getElementById('away_{{ loop.index }}').value)
              )"
              style="display:inline-block;">
              <!-- hidden field carries the match ID -->
              <input type="hidden" name="match_id" value="{{ match.id }}">

              <label for="home_{{ loop.index }}">H:</label>
              <input type="number" name="home" id="home_{{ loop.index }}" min="0" value="0" style="width:50px;">

              <label for="away_{{ loop.index }}">B:</label>
              <input type="number" name="away" id="away_{{ loop.index }}" min="0" value="0" style="width:50px;">

              <span id="result_{{ loop.index }}" class="w3-tag w3-grey w3-margin-left">U</span>
              
              <button type="submit" class="w3-button w3-black w3-margin-left"> Plasser spill </button>
            </form>

          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="w3-card w3-padding w3-margin-bottom w3-light-grey w3-center">
      <div class="w3-large">Ingen kamper de neste 7 dagene</div>
    </div>
  {% endif %}
</div>


<!--  Poengoversikt -->
<div class="w3-content w3-container w3-padding-16 w3-center" id="scoreboard">
  <div class="w3-xlarge w3-green w3-padding-10">Tippekongen</div>
  <div class="scrollable-table">
    <table class="w3-table-all w3-centered">
      <tr class="w3-darkblue">
        <th style="color: black"></th>
        <th style="color: black">Spiller</th>
        <th style="color: black">Poeng</th>
        <th style="color: black">H-U-B</th>
        <th style="color: black"><i class="fa fa-bullseye"></i></th>
      </tr>
      {% for player in player_scores %}
      <tr>
        <td style="font-weight: bold; color: grey">{{ loop.index }}</td>
        <td style="font-weight: bold">{{ player.username }}</td>
        <td>{{ player.score }}</td>
        <td>{{ player.n_correct }}</td>
        <td>{{ player.n_exact }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>


<!--  custom style for match displays on small / large screens -->
<style>
  .match-row {
    font-size: 18px;           /* default = large screens = w3-large */
    text-align: center;        /* default center */
  }

  @media (max-width: 600px) {
    .match-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;        /* small screens = w3-medium */
      text-align: left;       /* left-align text section */
    }
    .match-info {
      flex: 1;
      font-size: 14px;        /* small screens = w3-medium */
    }
    .match-right {
      display: flex;
      gap: 4px;
    }
  }
</style>

<div class="w3-content w3-container w3-padding-64" id="past_matches">
  <div class="w3-xlarge w3-center w3-light-blue w3-padding-10">Tidligere kamper</div>

  {% for round_number, matches in past_matches.items() %}
    <div class="w3-card w3-margin-top w3-margin-bottom">
      <button class="w3-button w3-block w3-left-align w3-light-grey"
              onclick="toggle_visibility('round_{{ round_number }}')">
        Runde {{ round_number }}
      </button>
    </div>
    <div id="round_{{ round_number }}" class="w3-hide w3-container w3-padding">
      {% for match in matches %}
  
        <div class="w3-card w3-padding w3-margin-bottom w3-light-grey w3-center"> 

          <div class="w3-large match-row">
            <span class="match-info">
              #{{ round_number }}:&nbsp;&nbsp; <b> {{ match.home_team }}</b> vs <b>{{ match.away_team }}</b>
            </span>
            <span class="match-right">
              <span class="w3-tag w3-black w3-margin-left w3-medium">
                {{ match.home_goals }} - {{ match.away_goals }}
              </span>
              {% set result_letter = 
                'H' if match.home_goals > match.away_goals 
                else 'B' if match.home_goals < match.away_goals 
                else 'U' 
              %}        
              <span class="w3-tag w3-margin-left w3-medium
                {% if result_letter == 'H' %} w3-blue
                {% elif result_letter == 'B' %} w3-black
                {% else %} w3-grey {% endif %}">
                {{ result_letter }}
              </span>
            </span>
          </div>

          <div class="w3-small w3-hide-small"> 
            {{ match.play_date.strftime('%d.%m.%Y') }} &nbsp;&nbsp; {{ match.play_date.strftime('%H:%M') }} 
          </div>

          <div id="player-bets" style="margin-top:10px;">
            {% for bet in bets_by_match.get(match.id, []) %}
              {% set is_exact = bet.goals_home == match.home_goals and bet.goals_away == match.away_goals %}
              {% set is_correct = bet.goals_home > bet.goals_away and match.home_goals > match.away_goals or
                                  bet.goals_home < bet.goals_away and match.home_goals < match.away_goals or
                                  bet.goals_home == bet.goals_away and match.home_goals == match.away_goals %}
              <span 
                class="w3-tag w3-medium" 
                style="
                  cursor:pointer;
                  margin-left:4px;
                  margin-right:4px;
                  background-color:
                    {% if is_exact %}#009b1a
                    {% elif is_correct %}#70b890
                    {% else %}#afafaf
                    {% endif %};
                onclick="
                  if (this.textContent === '{{ bet.username_short }}') {
                    this.textContent = '{{ bet.goals_home }} - {{ bet.goals_away }}';
                  } else {
                    this.textContent = '{{ bet.username_short }}';
                  }">
                {{ bet.username_short }}
              </span>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}

</div>

<script>
  function toggle_visibility(id) {
    var el = document.getElementById(id);
    if (el.classList.contains("w3-show")) {
      el.classList.remove("w3-show");
      el.classList.add("w3-hide");
    } else {
      el.classList.remove("w3-hide");
      el.classList.add("w3-show");
    }
  }
</script>

{% endblock %}






{% block scripts %}

<!-- check Login  -->
<script>

  function attemptLogin(password) {
    fetch('/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ password: password })
    })
    .then(response => {
      if (response.ok) {
        // Login successful – reload the page to update UI
        window.location.reload();
      } else {
        // Login failed – handle errors (e.g., show a message)
        alert('Login failed');
      }
    });
  }

</script>


<!--  Place bet on a single match -->
<script>
  async function placeBet(matchId, homeGoals, awayGoals) {
    const resp = await fetch("/place_bet", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        match_id: matchId,
        home:     homeGoals,
        away:     awayGoals
      })
    });
    const data = await resp.json();
    if (!data.success) {
      return alert("Error: " + data.error);
    } else {
      window.location.reload();
    }
    // maybe highlight the “Plasser spill” button as disabled now…
  }
</script>


<script>
  // attach event listeners for result
  {% for match in next_matches %}
    const homeInput{{ loop.index }} = document.getElementById('home_{{ loop.index }}');
    const awayInput{{ loop.index }} = document.getElementById('away_{{ loop.index }}');
    const resultTag{{ loop.index }} = document.getElementById('result_{{ loop.index }}');

    function updateResult{{ loop.index }}() {
      const homeGoals = parseInt(homeInput{{ loop.index }}.value);
      const awayGoals = parseInt(awayInput{{ loop.index }}.value);
      let result = '-';
      if (!isNaN(homeGoals) && !isNaN(awayGoals)) {
        if (homeGoals > awayGoals) result = 'H';
        else if (homeGoals < awayGoals) result = 'B';
        else result = 'U';
      }
      resultTag{{ loop.index }}.textContent = result;
    }

    homeInput{{ loop.index }}.addEventListener('input', updateResult{{ loop.index }});
    awayInput{{ loop.index }}.addEventListener('input', updateResult{{ loop.index }});
  {% endfor %}
</script>

{% endblock %}